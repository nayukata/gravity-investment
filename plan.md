# 投資タイミング判断アプリ『Dip Catcher』実装計画書

---

## 1. プロジェクト概要

- **製品名:** Dip Catcher（ディップ・キャッチャー）
- **目的:** 投資信託・ETF・指数において、感情を排し、統計的確率に基づいた「機械的な押し目買い」をサポートする。
- **コア体験:** アプリを開くだけで、登録した銘柄のデータが自動更新され、複数指標による総合スコアで「今が買い時か」が即座に分かる。

---

## 2. システム構成・データ戦略

ユーザーの手間（CSVダウンロード等）を完全に排除する設計とする。

### データソース戦略

データソースは信頼性の高い順に優先する。

```
優先順位: API > ライブラリ > 公開CSV > スクレイピング
```

| カテゴリ | データソース | 取得方法 | 信頼性 |
|---|---|---|---|
| 米国株・ETF | Yahoo Finance US | `yfinance`ライブラリ | 高 |
| 日本株・ETF | stooq.com | CSV直接取得 | 中〜高 |
| 日本の投資信託 | Yahoo!ファイナンスJP | スクレイピング（フォールバック） | 低 |
| 主要指数 | Yahoo Finance US | `yfinance`ライブラリ | 高 |

各データソースは共通インターフェース（`DataSource` Protocol）で抽象化し、銘柄カテゴリに応じて自動選択する。

### データフロー

1. **入力:** ユーザーが「銘柄コード」と「カテゴリ」を登録
2. **収集:** カテゴリに応じた最適なデータソースから時系列データを自動取得
3. **保存:** ローカルCSVにキャッシュ。次回以降は差分のみ取得
4. **分析:** 複数指標を計算し、総合スコアを算出
5. **表示:** Streamlitダッシュボードに結果を表示

---

## 3. 機能要件

### A. データ取得機能

- 銘柄カテゴリに基づき、最適なデータソースを自動選択
- `yfinance`: 米国株・ETF・主要指数の時系列データ取得
- `stooq`: 日本株・一部指数のCSVデータ取得
- `yahoo_jp`: 日本の投資信託データのスクレイピング（サーバー負荷に配慮したアクセス間隔制御）
- ローカルCSVキャッシュによる差分更新で高速化
- データソース障害時のフォールバック（キャッシュデータ + 警告表示）

### B. 投資判断指標の計算

1. **ドローダウン（下落率）**
   - 直近の最高値からの下落率を計算
   - 「-10%」「-20%」などの節目を可視化

2. **期間リターン（ポテンシャル）**
   - 表示期間内における最大上昇幅やトータルリターンを表示

3. **統計的レアリティ（頻度分布）**
   - 過去数年間の日次/週次騰落率の分布（ヒストグラム）を作成
   - 現在の下落幅が統計的に「異常値（＝チャンス）」かどうかを判定
   - 例: 「この下落幅は、過去5年で上位5%のレアな水準です」

4. **移動平均乖離率**
   - 価格と移動平均線の乖離率を計算
   - -5%以下で「売られすぎ」を示唆

5. **RSI（相対力指数・14日）**
   - 30以下で「売られすぎ」、70以上で「買われすぎ」を判定

6. **ボリンジャーバンド**
   - 価格の統計的な位置を算出
   - -2σ以下で「レアな下落」を検知

7. **過去ドローダウン一覧**
   - 過去の同程度の下落イベントを一覧表示
   - 各下落後の回復期間・回復率を分析

### C. 総合スコアリング

複数指標を0〜100にスコア化し、合計で判定する。

| スコア | 判定 | 意味 |
|---|---|---|
| 80+ | 強い買い場 | 複数指標が「レアな下落」を示唆 |
| 60-79 | 買い場検討 | 一部指標がシグナル |
| 40-59 | 様子見 | 通常範囲 |
| 0-39 | 待機 | 下落初期 or 上昇中 |

---

## 4. UI/UX デザイン（画面構成）

### サイドバー（設定）

- **監視リスト管理:** 銘柄コード・名称・カテゴリの追加/削除
- **分析設定:** 期間（1年/3年/全期間）、移動平均線の日数
- **データ更新ボタン:** 手動で最新情報を取得するトリガー

### メイン画面（ダッシュボード）

- **サマリーパネル:**
  - 現在の基準価額
  - 最高値からの下落率（%）
  - 総合スコア + 判定ラベル
- **メインチャート:**
  - 基準価額推移（ラインチャート）+ 移動平均線
  - ドローダウンの深さ（面グラフ）
  - ボリンジャーバンド（帯表示）
- **分析パネル:**
  - 騰落率のヒストグラム + 現在位置マーカー
  - RSI推移チャート
  - 各指標のスコア内訳表示
  - 過去ドローダウン一覧テーブル

---

## 5. 技術スタック

- **言語:** Python 3.10+
- **パッケージ管理:** uv
- **フレームワーク:** Streamlit
- **データ処理:** pandas, numpy
- **データ取得:** yfinance, requests, BeautifulSoup4
- **可視化:** Plotly
- **型安全・設定管理:** Pydantic
- **テスト:** pytest

---

## 6. ディレクトリ構成

```text
dip_catcher/
├── pyproject.toml
├── src/
│   └── dip_catcher/
│       ├── __init__.py
│       ├── app.py              # Streamlit UI
│       ├── config.py           # 設定・銘柄リスト管理
│       ├── models.py           # データ型定義（Pydantic）
│       ├── logic.py            # 統計・指標計算・スコアリング
│       └── sources/            # データソース群
│           ├── __init__.py
│           ├── base.py         # 共通インターフェース（Protocol）
│           ├── yfinance.py     # 米国株・ETF・指数
│           ├── stooq.py        # 日本株・一部指数
│           └── yahoo_jp.py     # 日本の投資信託
├── tests/
│   ├── test_logic.py           # 計算ロジックのユニットテスト
│   └── test_sources.py         # データソースの統合テスト
└── data/                       # キャッシュCSV保存先（.gitignore対象）
```

---

## 7. 非機能要件

### エラーハンドリング

- データソース接続失敗 → キャッシュデータでフォールバック表示（「最終更新: ○○」と注記）
- スクレイピング対象のHTML構造変更 → パースエラー検知 + ユーザー警告
- 無効な銘柄コード → 登録時にバリデーション

### テスト戦略

- `logic.py`の計算ロジック → 既知データでの検算ユニットテスト
- データソース → モックを使った統合テスト
- UI → 手動確認

### 設定の永続化

- 銘柄リスト・分析パラメータ → `~/.dip_catcher/config.toml` に保存
- Pydanticバリデーション付きの設定モデル

---

## 8. 開発ロードマップ

### Phase 1: プロジェクト基盤 + データ取得

- uv でプロジェクト初期化、依存インストール
- Pydantic でデータモデル・設定モデル定義
- `yfinance` ソースの実装（米国株・ETF・指数）
- `stooq` ソースの実装（日本株・一部指数）
- `yahoo_jp` スクレイパーの実装（日本の投資信託）
- キャッシュ機構（ローカルCSV保存 + 差分更新）
- **完了条件:** 各ソースから銘柄データを取得・保存でき、テストが通る

### Phase 2: 分析ロジック

- ドローダウン計算
- 騰落率分布 + 統計的レアリティ
- 移動平均乖離率
- RSI（14日）
- ボリンジャーバンド
- 過去ドローダウン一覧
- 総合スコアリング
- **完了条件:** 既知データで計算結果を検算するユニットテストが通る

### Phase 3: UI

- Streamlit ダッシュボード構築
- サイドバー（銘柄登録・設定）
- サマリーパネル（スコア・判定表示）
- メインチャート（Plotly: 価格推移 + ドローダウン + ボリンジャーバンド）
- 分析パネル（ヒストグラム + RSI + 各指標スコア内訳）
- **完了条件:** 銘柄を登録し、データ取得 → 分析 → 表示の一連フローが動作する

### Phase 4: 仕上げ

- エラーハンドリング強化（フォールバック表示）
- 設定の永続化（TOML）
- UIの微調整
- **完了条件:** エラーケース（ネットワーク断、無効コード等）で適切にフォールバックする
